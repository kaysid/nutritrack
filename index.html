<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack</title>
    <style>
        /* Assuming basic styles are present; add any necessary for layout */
        .macro { display: flex; flex-direction: column; }
        .bar { height: 10px; background: grey; }
        .fill { height: 100%; background: green; }
        .meal-card { border: 1px solid #ccc; padding: 10px; margin: 5px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
        /* No animation yet, as this is first version */
    </style>
</head>
<body>

    <header>
        NutriTrack
        <button id="reset-btn">Reset</button>
    </header>

    <section id="progress">
        <h1>Today</h1>
        <div class="macro">
            <div>Calories 0 / 2000</div>
            <div class="bar"><div class="fill" style="width: 0%;"></div></div>
            <div class="percent">0%</div>
        </div>
        <div class="macro">
            <div>Protein 0g / 50g</div>
            <div class="bar"><div class="fill" style="width: 0%;"></div></div>
            <div class="percent">0%</div>
        </div>
        <div class="macro">
            <div>Carbs 0g / 250g</div>
            <div class="bar"><div class="fill" style="width: 0%;"></div></div>
            <div class="percent">0%</div>
        </div>
        <div class="macro">
            <div>Fat 0g / 65g</div>
            <div class="bar"><div class="fill" style="width: 0%;"></div></div>
            <div class="percent">0%</div>
        </div>
        <h2>Meals</h2>
        <div id="today-meals"></div>
    </section>

    <section id="meals">
        <h2>Meal Library</h2>
        <div class="meal-library">
            <button id="add-meal-library-btn">+ Add</button>
            <button id="scan-barcode-btn">Scan Barcode</button>
            <div id="meal-library"></div>
        </div>
    </section>

    <section id="settings">
        <h2>Daily Targets</h2>
        <div class="targets-form">
            <label>Calories</label>
            <input id="target-cal" type="number" value="2000">
            <label>Protein (g)</label>
            <input id="target-pro" type="number" value="50">
            <label>Carbs (g)</label>
            <input id="target-car" type="number" value="250">
            <label>Fat (g)</label>
            <input id="target-fat" type="number" value="65">
            <button id="save-targets">Save</button>
        </div>
        <h2>Data Management</h2>
        <button id="copy-data">Copy Data to Clipboard</button>
        <button id="import-data">Import from Paste</button>
    </section>

    <nav>
        <a href="#progress">Progress</a>
        <a href="#meals">Meals</a>
        <a href="#settings">Settings</a>
    </nav>

    <!-- Modals -->
    <div id="add-meal-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Add Meal</h2>
            <span class="close">&times;</span>
            <label>Name</label>
            <input id="meal-name" type="text">
            <label>Calories</label>
            <input id="meal-cal" type="number">
            <label>Protein (g)</label>
            <input id="meal-pro" type="number">
            <label>Carbs (g)</label>
            <input id="meal-car" type="number">
            <label>Fat (g)</label>
            <input id="meal-fat" type="number">
            <button id="add-meal-btn">Add</button>
        </div>
    </div>

    <div id="add-to-today-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Add to Today</h2>
            <span class="close">&times;</span>
            <label>servings</label>
            <input id="servings" type="number" value="1">
            <button id="add-from-modal-btn">Add</button>
        </div>
    </div>

    <div id="product-found-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Product Found</h2>
            <span class="close">&times;</span>
            <!-- Product info would go here -->
        </div>
    </div>

    <div id="scanner-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button id="close-scanner">Close Scanner</button>
            <div>Point Camera at Barcode [Security Blocks Previews]</div>
            <!-- Video element for scanner would go here -->
        </div>
    </div>

    <script>
        // Data structures
        let dailyTargets = { calories: 2000, protein: 50, carbs: 250, fat: 65 };
        let mealLibrary = [];
        let todaysMeals = [];
        let currentMealName = '';

        // Update macro displays
        function updateMacros() {
            let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            todaysMeals.forEach(m => {
                for (let key in totals) {
                    totals[key] += m[key] * m.servings;
                }
            });
            const macros = ['calories', 'protein', 'carbs', 'fat'];
            const units = ['', 'g', 'g', 'g'];
            macros.forEach((key, index) => {
                let macroDiv = document.querySelectorAll('#progress .macro')[index];
                let total = Math.round(totals[key]);
                let target = dailyTargets[key];
                let unit = units[index];
                macroDiv.querySelector('div:first-child').textContent = `${key.charAt(0).toUpperCase() + key.slice(1)} ${total}${unit} / ${target}${unit}`;
                let percent = Math.min((totals[key] / target * 100), 100).toFixed(0);
                macroDiv.querySelector('.fill').style.width = percent + '%';
                macroDiv.querySelector('.percent').textContent = percent + '%';
            });
        }

        // Render today's meals in Progress tab with merging and increment/decrement
        function renderTodaysMeals() {
            const mealsDiv = document.getElementById('today-meals');
            mealsDiv.innerHTML = '';
            todaysMeals.forEach(m => {
                const countStr = m.servings > 1 ? ` (${m.servings}x)` : '';
                const card = document.createElement('div');
                card.className = 'meal-card';
                card.innerHTML = `
                    <span>${m.name}${countStr}</span>
                    <span>Cal: ${m.calories}</span>
                    <span>Pro: ${m.protein}g</span>
                    <span>Car: ${m.carbs}g</span>
                    <span>Fat: ${m.fat}g</span>
                    <button onclick="incrementMeal('${m.name}', 1)">+</button>
                    <button onclick="incrementMeal('${m.name}', -1)">-</button>
                `;
                mealsDiv.appendChild(card);
            });
            updateMacros();
        }

        // Increment/decrement servings, remove if <=0
        window.incrementMeal = function(name, delta) {
            const m = todaysMeals.find(m => m.name === name);
            if (m) {
                m.servings += delta;
                if (m.servings <= 0) {
                    todaysMeals = todaysMeals.filter(m => m.name !== name);
                }
                renderTodaysMeals();
                renderMealLibrary(); // Sync with Meals tab counters if any (for future)
            }
        }

        // Add meal to today, merge if exists
        function addToToday(meal, servings = 1) {
            const existing = todaysMeals.find(m => m.name === meal.name);
            if (existing) {
                existing.servings += servings;
            } else {
                todaysMeals.push({ ...meal, servings });
            }
            renderTodaysMeals();
        }

        // Render meal library with add button opening modal
        function renderMealLibrary() {
            const libraryDiv = document.getElementById('meal-library');
            libraryDiv.innerHTML = '';
            mealLibrary.forEach(m => {
                const card = document.createElement('div');
                card.className = 'meal-card';
                card.innerHTML = `
                    <span>${m.name}</span>
                    <span>Cal: ${m.calories}</span>
                    <span>Pro: ${m.protein}g</span>
                    <span>Car: ${m.carbs}g</span>
                    <span>Fat: ${m.fat}g</span>
                    <button onclick="openAddToTodayModal('${m.name}')">Add to Today</button>
                `;
                libraryDiv.appendChild(card);
            });
        }

        // Add new meal from modal
        function addMeal() {
            const name = document.getElementById('meal-name').value.trim();
            const calories = parseFloat(document.getElementById('meal-cal').value);
            const protein = parseFloat(document.getElementById('meal-pro').value);
            const carbs = parseFloat(document.getElementById('meal-car').value);
            const fat = parseFloat(document.getElementById('meal-fat').value);
            if (name && !isNaN(calories) && !isNaN(protein) && !isNaN(carbs) && !isNaN(fat)) {
                mealLibrary.push({ name, calories, protein, carbs, fat });
                renderMealLibrary();
                document.getElementById('add-meal-modal').style.display = 'none';
            }
        }

        // Open add to today modal
        window.openAddToTodayModal = function(name) {
            currentMealName = name;
            document.getElementById('add-to-today-modal').style.display = 'block';
        }

        // Add from modal
        function addFromModal() {
            const servings = parseFloat(document.getElementById('servings').value) || 1;
            const meal = mealLibrary.find(m => m.name === currentMealName);
            if (meal) {
                addToToday(meal, servings);
            }
            document.getElementById('add-to-today-modal').style.display = 'none';
        }

        // Save targets
        function saveTargets() {
            dailyTargets.calories = parseFloat(document.getElementById('target-cal').value) || dailyTargets.calories;
            dailyTargets.protein = parseFloat(document.getElementById('target-pro').value) || dailyTargets.protein;
            dailyTargets.carbs = parseFloat(document.getElementById('target-car').value) || dailyTargets.carbs;
            dailyTargets.fat = parseFloat(document.getElementById('target-fat').value) || dailyTargets.fat;
            updateMacros();
        }

        // Copy data
        function copyData() {
            const data = { dailyTargets, mealLibrary };
            navigator.clipboard.writeText(JSON.stringify(data));
        }

        // Import data
        function importData() {
            const paste = prompt('Paste data');
            if (paste) {
                const data = JSON.parse(paste);
                dailyTargets = data.dailyTargets || dailyTargets;
                mealLibrary = data.mealLibrary || mealLibrary;
                renderMealLibrary();
                renderTodaysMeals();
            }
        }

        // Event listeners
        document.getElementById('reset-btn').onclick = () => {
            todaysMeals = [];
            renderTodaysMeals();
        };
        document.getElementById('add-meal-library-btn').onclick = () => document.getElementById('add-meal-modal').style.display = 'block';
        document.getElementById('add-meal-btn').onclick = addMeal;
        document.getElementById('add-from-modal-btn').onclick = addFromModal;
        document.getElementById('save-targets').onclick = saveTargets;
        document.getElementById('copy-data').onclick = copyData;
        document.getElementById('import-data').onclick = importData;
        // Close modals on x
        document.querySelectorAll('.close').forEach(close => {
            close.onclick = () => close.parentElement.parentElement.style.display = 'none';
        });
        // Scanner and barcode buttons skipped for simplicity, as not central to task

        // Initial renders
        renderTodaysMeals();
        renderMealLibrary();
    </script>

</body>
</html>
